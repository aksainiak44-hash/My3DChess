<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Chess Game ‚Äì OMNIPRESENT VOICE EDITION</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-dark: #020617;
      --accent: #38bdf8;
      --gold: #facc15;
      --glass: rgba(15,23,42,0.9);
      /* Default Theme Variables */
      --light-square: #f0d9b5;
      --dark-square: #b58863;
      
      --mic-on: #10b981;
      --mic-off: #ef4444;
      --popup-bg: #1f2937;
      --popup-text: #e5e7eb;
      --popup-border: #4b5563;
      /* Dynamic Lighting Variables */
      --light-x: 0px;
      --light-y: 6px;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    
    /* Animated Galaxy Background */
    @keyframes drift { from { transform: translateY(0); } to { transform: translateY(-1000px); } }
    .space-bg { position: fixed; top:0; left:0; width: 100vw; height: 200vh; z-index: -1; background: transparent url('https://www.transparenttextures.com/patterns/stardust.png') repeat top center; animation: drift 60s linear infinite; pointer-events: none; opacity: 0.5; transition: opacity 0.5s;}
    
    body{
      min-height:100vh; padding:16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at 0% 0%, #1f2937 0, #020617 50%), radial-gradient(circle at 100% 100%, #0f172a 0, #020617 60%);
      color:#e5e7eb; display:flex; flex-direction:column; align-items:center; gap:12px; overflow-x: hidden;
      transition: background 0.5s;
    }
    
    /* ZEN MODE STYLES */
    body.zen-mode { background: #000; }
    body.zen-mode .space-bg { opacity: 0.1; }
    body.zen-mode .hide-in-zen { display: none !important; }
    body.zen-mode .board-wrapper { transform: scale(1.05); transition: transform 0.5s; margin-top: 30px; }

    /* QUANTUM RIPPLE EFFECT */
    .ripple-effect {
      position: fixed; border-radius: 50%; border: 2px solid var(--accent); box-shadow: 0 0 10px var(--accent);
      pointer-events: none; animation: rippleAnim 0.6s ease-out forwards; z-index: 9999;
      transform: translate(-50%, -50%);
    }
    @keyframes rippleAnim { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 100px; height: 100px; opacity: 0; } }

    h1{
      font-size:24px; text-transform:uppercase; letter-spacing:.12em;
      background: linear-gradient(120deg,#e5e7eb,#facc15,#e5e7eb);
      -webkit-background-clip:text; color:transparent;
      text-shadow:0 2px 8px rgba(0,0,0,.8); font-weight: 900;
    }
    .subtitle{ font-size:11px; text-transform:uppercase; color:#9ca3af; letter-spacing:.2em; font-weight:bold;}

    /* Board & Eval Wrapper */
    .board-wrapper { display: flex; align-items: stretch; gap: 10px; margin: 10px 0; width: 360px; max-width: 95vw; transition: transform 0.5s; }
    
    /* Evaluation Bar */
    .eval-bar-container {
        width: 12px; border-radius: 6px; background: #222; overflow: hidden; 
        border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 10px 20px rgba(0,0,0,0.8);
        display: flex; flex-direction: column; position: relative;
    }
    .eval-fill-black { background: #111; width: 100%; transition: height 0.4s ease; height: 50%; }
    .eval-fill-white { background: #eee; width: 100%; transition: height 0.4s ease; height: 50%; }
    .eval-indicator { position: absolute; top: 50%; left: -2px; width: 16px; height: 2px; background: var(--accent); z-index: 2; box-shadow: 0 0 5px var(--accent);}

    /* 3D Board Shell */
    .board-shell{ flex: 1; perspective:1200px; position: relative;}
    
    /* Screen Shake Animation */
    @keyframes shakeImpact { 0% { transform: rotateX(15deg) translate(3px, 2px); } 20% { transform: rotateX(15deg) translate(-3px, -2px); } 40% { transform: rotateX(15deg) translate(-3px, 2px); } 60% { transform: rotateX(15deg) translate(3px, -2px); } 80% { transform: rotateX(15deg) translate(1px, 1px); } 100% { transform: rotateX(15deg) translate(0, 0); } }
    .shake-impact { animation: shakeImpact 0.3s cubic-bezier(.36,.07,.19,.97) both !important; }

    .board-frame{
      width:100%; padding:10px; border-radius:20px;
      background: linear-gradient(135deg,#020617,#111827);
      box-shadow:0 26px 40px rgba(0,0,0,.95), inset 0 0 0 1px rgba(148,163,184,.25);
      transform: rotateX(15deg); transform-origin:center top;
      transition: box-shadow 0.4s ease, transform 0.1s;
    }
    
    /* Turn Glow Effects */
    .turn-glow-white { box-shadow: 0 0 40px rgba(255, 255, 255, 0.2), inset 0 0 0 1px rgba(255,255,255,.5); }
    .turn-glow-black { box-shadow: 0 0 40px rgba(250, 204, 21, 0.2), inset 0 0 0 1px rgba(250,204,21,.5); }

    /* Cinematic Spin Animation */
    @keyframes cinematicSpin { 0% { transform: rotateX(25deg) rotateZ(0deg); } 100% { transform: rotateX(25deg) rotateZ(360deg); } }
    .cinematic-mode { animation: cinematicSpin 20s linear infinite !important; }

    .board{
      width:100%; padding-bottom:100%; position:relative;
      border-radius:14px; overflow:hidden;
      box-shadow:0 14px 30px rgba(0,0,0,.95), inset 0 0 0 1px rgba(15,23,42,.9);
      background:#d1d5db; transition: background 0.3s ease;
    }
    .square{ position:absolute; width:12.5%; height:12.5%; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; transition: transform .08s ease-out, box-shadow .12s ease-out, filter .12s ease-out, background 0.3s ease; font-size:28px; }
    .square.light{ background:var(--light-square); } .square.dark { background:var(--dark-square); }
    .square:active{ transform:scale(.96); box-shadow: inset 0 3px 10px rgba(0,0,0,.9); }
    
    /* Pro Coordinates (1-8, a-h) */
    .coord-letter { position: absolute; bottom: 2px; right: 4px; font-size: 10px; font-weight: bold; color: rgba(0,0,0,0.5); pointer-events: none; }
    .coord-number { position: absolute; top: 2px; left: 4px; font-size: 10px; font-weight: bold; color: rgba(0,0,0,0.5); pointer-events: none; }
    .dark .coord-letter, .dark .coord-number { color: rgba(255,255,255,0.6); }

    /* 3D Pieces & DYNAMIC Shadows */
    .piece-img{ 
        width:80%; height:80%; object-fit:contain; background:none !important; 
        filter: drop-shadow(var(--light-x) var(--light-y) 4px rgba(0,0,0,.8)); 
        transition: transform .2s ease; z-index: 2;
    }
    .piece-img:hover { transform: translateY(-3px) scale(1.05); filter: drop-shadow(var(--light-x) calc(var(--light-y) + 5px) 8px rgba(0,0,0,1)); }
    
    /* Skins */
    .skin-neon .piece-img { filter: hue-rotate(90deg) drop-shadow(0 0 8px var(--accent)) saturate(1.5) brightness(1.2); }
    .skin-shadow .piece-img { filter: brightness(0) drop-shadow(var(--light-x) var(--light-y) 4px rgba(255,255,255,0.3)); }

    .selected{ outline:3px solid var(--gold); outline-offset:-3px; filter:brightness(1.1); z-index: 10;}
    .last-move{ background: rgba(250, 204, 21, 0.4) !important; box-shadow: inset 0 0 0 2px rgba(250, 204, 21, 0.8); }
    .in-check { 
        background: rgba(239, 68, 68, 0.7) !important; 
        box-shadow: inset 0 0 30px rgba(239, 68, 68, 0.9), 0 0 20px rgba(239, 68, 68, 0.8) !important; 
        animation: pulse-red 1s infinite; z-index: 5;
    }
    @keyframes pulse-red { 0% { filter: brightness(1); } 50% { filter: brightness(1.4); } 100% { filter: brightness(1); } }
    
    /* Hint Dots */
    .hint-dot { width: 28%; height: 28%; background: rgba(52, 211, 153, 0.8); border-radius: 50%; pointer-events: none; z-index: 1; box-shadow: 0 0 8px rgba(52, 211, 153, 0.6); }
    .hint-capture { width: 85%; height: 85%; border: 4px solid rgba(239, 68, 68, 0.8); border-radius: 50%; pointer-events: none; z-index: 3; box-shadow: inset 0 0 10px rgba(239,68,68,0.5); }

    /* Panels */
    .panel{ width:100%; max-width:360px; background:var(--glass); padding:10px 14px; border-radius:16px; box-shadow:0 16px 30px rgba(0,0,0,.9), inset 0 0 0 1px rgba(148,163,184,.2); backdrop-filter:blur(14px); position: relative; }
    .panel-header{ display:flex; justify-content:space-between; align-items:baseline; margin-bottom:4px; }
    .label{ font-size:11px; color:#9ca3af; text-transform:uppercase; letter-spacing:.18em; font-weight: bold;} 
    .status-text{ font-size:14px; font-weight: bold; color: var(--gold); }
    .panel-buttons{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; margin-bottom:4px; justify-content:flex-start; }
    button{ background: linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; border:none; padding:6px 12px; border-radius:999px; font-size:13px; box-shadow:0 4px 10px rgba(37,99,235,.7); cursor:pointer; font-weight: 600; transition: 0.2s;}
    button:active{ transform: scale(0.95); }
    button.small{ font-size:11px; padding:4px 10px; }
    
    /* Timers */
    .timers{ display:flex; justify-content:space-between; gap:10px; margin-top:6px; margin-bottom:4px; }
    .timer-box{ flex:1; padding:6px 8px; border-radius:10px; background:rgba(15,23,42,.85); border: 1px solid #334155; text-align: center;}
    .timer-name{ font-size:11px; text-transform:uppercase; letter-spacing:.12em; margin-bottom: 3px;} .timer-value{ font-variant-numeric: tabular-nums; font-size:16px; font-weight: bold;}
    .timer-active{ box-shadow: 0 0 0 2px rgba(56,189,248,.8), 0 0 12px rgba(56,189,248,.5); }

    /* Move History & Chat */
    #movesList{ max-height:120px; overflow-y:auto; font-size:12px; line-height:1.6; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px;} 
    .move-row{ display:flex; gap:6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px;} 
    .move-index{ width:26px; color:#9ca3af; }
    
    .chat-panel { display: flex; flex-direction: column; gap: 6px; margin-top: 6px; }
    .chat-messages { height: 110px; overflow-y: auto; background: rgba(0,0,0,0.4); border-radius: 8px; padding: 6px; font-size: 12px; display: flex; flex-direction: column; gap: 4px; border: 1px solid #334155;}
    .chat-msg { padding: 5px 10px; border-radius: 8px; max-width: 85%; word-wrap: break-word;}
    .chat-msg.mine { background: rgba(56,189,248,0.2); align-self: flex-end; border-bottom-right-radius: 0; color: #e0f2fe; }
    .chat-msg.theirs { background: rgba(250,204,21,0.2); align-self: flex-start; border-bottom-left-radius: 0; color: #fef08a;}
    
    /* Typing Indicator & Ping Dot */
    .typing-indicator { font-size: 10px; color: var(--accent); font-style: italic; display: none; text-align: left; padding-left: 5px; animation: blink 1.5s infinite;}
    @keyframes blink { 0%, 100% {opacity:1;} 50% {opacity:0.3;} }
    .ping-dot { width:8px; height:8px; background:#4ade80; border-radius:50%; display:inline-block; box-shadow:0 0 8px #4ade80; animation: pulse-green 2s infinite; margin-left: 5px;}
    @keyframes pulse-green { 0% { opacity:1; } 50% { opacity:0.4; } 100% { opacity:1; } }

    /* Captured Pieces Area */
    .captured-area { min-height: 18px; font-size: 14px; color: #9ca3af; margin-top: 4px; letter-spacing: 2px;}

    /* Bot Settings */
    .bot-settings{ display:flex; flex-direction:column; gap:6px; margin-top:4px; font-size:12px; } .bot-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; } .bot-row label{ font-size:11px; color:#d1d5db; } .bot-row select{ flex:1; background:#020617; border-radius:999px; border:1px solid #4b5563; padding:3px 8px; color:#e5e7eb; font-size:11px; outline:none; }
    .about-text{ font-size:12px; line-height:1.5; margin-top:6px; }
    .invite-btn{ background:linear-gradient(135deg,#10b981,#059669); box-shadow:0 4px 10px rgba(5,150,105,.6); }

    /* Mic button styling & Avatar Glow */
    .mic-btn{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer; border:1px solid rgba(255,255,255,0.06); background: linear-gradient(135deg,#111827,#0b1220); color:#e5e7eb; box-shadow: 0 4px 10px rgba(0,0,0,0.6); }
    .mic-btn .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; box-shadow: 0 0 6px rgba(0,0,0,0.6); }
    .mic-on .dot{ background: var(--mic-on); } .mic-off .dot{ background: var(--mic-off); }
    
    /* Live Mic Visualizer Glow */
    .avatar-img { width:56px; height:56px; border-radius:50%; object-fit:cover; border:2px solid var(--accent); transition: box-shadow 0.1s ease; }

    /* Theme & Skins Selectors */
    .select-box { background:#0f172a; color:#fff; border:1px solid var(--accent); padding:4px 8px; border-radius:8px; font-size:11px; outline:none; cursor:pointer;}
    .slider-container { display: flex; align-items: center; gap: 8px; margin-top: 6px; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 8px;}
    input[type=range] { flex: 1; accent-color: var(--accent); cursor: pointer; }

    /* Modals & Overlays */
    #inviteOverlay, #gameOverOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(8px); }
    #inviteOverlay.show, #gameOverOverlay.show { display: flex; }
    
    #invitePopup { background: var(--popup-bg); color: var(--popup-text); padding: 24px; border-radius: 16px; text-align: center; box-shadow: 0 16px 40px rgba(0,0,0,0.9); border: 2px solid var(--gold); min-width: 280px; }
    #invitePopup h2 { font-size: 22px; margin-bottom: 10px; color: var(--gold); text-transform: uppercase;}
    #invitePopup .invite-info { font-size: 15px; margin-bottom: 20px; line-height: 1.6; }
    #acceptBtn { background: linear-gradient(135deg,#10b981,#059669); padding: 10px 20px; border:none; border-radius:999px; color:#fff; cursor:pointer; font-weight: bold;}
    #declineBtn { background: #dc2626; padding: 10px 20px; border:none; border-radius:999px; color:#fff; cursor:pointer; font-weight: bold;}

    /* Premium Game Over Modal */
    #gameOverPopup { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px rgba(250, 204, 21, 0.4); border: 2px solid var(--gold); min-width: 300px; transform: scale(0.8); transition: transform 0.3s ease; position: relative; z-index: 10002;}
    #gameOverOverlay.show #gameOverPopup { transform: scale(1); }
    #gameOverTitle { font-size: 32px; font-weight: 900; color: var(--gold); margin-bottom: 5px; text-shadow: 0 4px 10px rgba(0,0,0,0.8); }
    #gameOverDesc { font-size: 16px; color: #9ca3af; margin-bottom: 20px; }
    #closeModalBtn { background: var(--accent); color: #000; padding: 10px 30px; border: none; border-radius: 999px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.5);}

    /* Victory Confetti Canvas */
    #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10001; display: none; }

    /* WhatsApp Draggable Video Container */
    #videoCallContainer {
      position: fixed; top: 70px; right: 20px; width: 140px; height: 190px;
      cursor: move; z-index: 9999; display: none; border-radius: 12px;
      overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.8); background: #000;
      border: 2px solid var(--accent); touch-action: none;
    }
    #videoCallContainer.active { display: block; }
    .remote-video { width: 100%; height: 100%; object-fit: cover; transform: rotateY(180deg); }
    .local-video-box {
      position: absolute; bottom: 8px; right: 8px; width: 45px; height: 60px;
      border: 1px solid #fff; border-radius: 6px; z-index: 1000; overflow:hidden; background: #111;
    }
    .local-video { width: 100%; height: 100%; object-fit: cover; transform: rotateY(180deg); }
  </style>
</head>
<body>
  <div class="space-bg"></div>
  <canvas id="confettiCanvas"></canvas>

  <h1 class="hide-in-zen">3D Chess Game</h1>
  <div class="subtitle hide-in-zen">OMNIPRESENT VOICE EDITION üéôÔ∏èüåå</div>

  <div id="loginContainer" class="panel hide-in-zen" style="max-width:360px; margin-top:0;"></div>
  
  <div style="margin-bottom:6px;" class="hide-in-zen">
    <button id="modeBtn" class="small">Mode: 2P Online</button>
  </div>

  <div class="panel" style="display:flex;align-items:center;gap:10px;">
    <img id="playerAvatarTop" class="avatar-img" src="https://via.placeholder.com/56" alt="Avatar" />
    <div style="flex:1;">
      <div style="display:flex; align-items:center; gap:8px;">
        <input id="playerNameInput" type="text" placeholder="Your name..." style="flex:1;padding:6px;border-radius:8px;border:1px solid #374151;background:rgba(255,255,255,0.03);color:#e5e7eb;" />
      </div>
      <div style="margin-top:6px;font-size:13px;color:#d1d5db;">
        <span id="playerNameDisplay">Player 1: ‚Äî</span> <span class="ping-dot" style="display:none;" id="pingTop"></span>
      </div>
      <div id="capturedTop" class="captured-area"></div>
      
      <div style="margin-top:4px;" class="hide-in-zen">
        <div style="font-size:11px;color:#9ca3af;margin-bottom:2px;">Level OMNI / XP</div>
        <div style="background:#0f172a;border-radius:999px;padding:4px;display:flex;align-items:center;gap:8px;">
          <div style="flex:1;background:#111827;border-radius:999px;height:6px;overflow:hidden;">
            <div id="xpBar" style="height:6px;width:100%;background:linear-gradient(90deg,#facc15,#38bdf8);"></div>
          </div>
        </div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
      <button id="micTopBtn" class="small mic-btn mic-on"><span class="dot"></span><span class="mic-label">Mic On</span></button>
      <div style="font-size:8px; color:var(--accent); text-align:center;">Hold Space to Talk</div>
    </div>
  </div>

  <div class="board-wrapper">
      <div class="eval-bar-container">
          <div class="eval-indicator" id="evalIndicator"></div>
          <div class="eval-fill-black" id="evalBlack"></div>
          <div class="eval-fill-white" id="evalWhite"></div>
      </div>
      
      <div class="board-shell" id="boardShell">
        <div class="board-frame" id="boardFrame">
          <div id="board" class="board skin-classic"></div>
        </div>
      </div>
  </div>

  <div id="playerProfileBottom" class="panel" style="display:flex;align-items:flex-start;gap:10px;">
    <img id="playerAvatarBottom" src="https://via.placeholder.com/48" alt="Avatar" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid var(--gold);" />
    <div style="flex:1;">
      <div style="display:flex;align-items:center;gap:6px;">
        <input id="bottomNameInput" type="text" placeholder="Opponent Name..." style="flex:1;padding:6px;border-radius:8px;border:1px solid #374151;background:rgba(255,255,255,0.03);color:#e5e7eb;font-size:12px;">
      </div>
      <div style="margin-top:6px;font-size:16px;color:#e5e7eb;">
        <strong id="playerNameBottom" style="color:var(--gold);">Waiting for Friend...</strong> <span class="ping-dot" style="display:none;" id="pingBottom"></span>
      </div>
      <div id="capturedBottom" class="captured-area"></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
       <button id="videoToggleBtn" class="small" style="background:#facc15; color: #020617; font-weight:bold;">Video: OFF</button>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header hide-in-zen">
      <div class="label">Match Status</div>
      <div style="display:flex; gap:4px;">
          <select id="skinSelect" class="select-box">
            <option value="skin-classic" selected>‚ôüÔ∏è Classic 3D</option>
            <option value="skin-neon">‚ö° Neon Glow</option>
            <option value="skin-shadow">üåë Silhouette</option>
          </select>
          <select id="themeSelect" class="select-box">
            <option value="wood" selected>üå≤ Wood</option>
            <option value="glass">üßä Glass</option>
            <option value="emerald">üü¢ Emerald</option>
            <option value="neon">üü£ Cyberpunk</option>
          </select>
      </div>
    </div>
    <div id="status" class="status-text" style="text-align:center; font-size:16px; margin: 5px 0;">White to move</div>

    <div class="slider-container hide-in-zen">
      <div class="label" style="margin:0;">3D Angle</div>
      <input type="range" id="cameraAngle" min="0" max="45" value="15">
      <button id="cinematicBtn" class="small" style="background:#8b5cf6; padding: 2px 6px;">üé¨ Spin</button>
    </div>

    <div class="timers">
      <div id="whiteTimerBox" class="timer-box timer-active">
        <div class="timer-name white">White Timer</div>
        <div id="whiteTimer" class="timer-value">10:00</div>
      </div>
      <div id="blackTimerBox" class="timer-box">
        <div class="timer-name black">Black Timer</div>
        <div id="blackTimer" class="timer-value">10:00</div>
      </div>
    </div>

    <div class="panel-buttons">
      <button id="zenBtn" style="background:#8b5cf6;">Zen Mode üßò</button>
      <button id="resetBtn" style="background:#3b82f6;">Restart</button>
      <button id="resignBtn" style="background:#f97316;">Resign üè≥Ô∏è</button>
      <button id="flipBtn" class="small">Flip Board</button>
    </div>

    <div class="panel-header hide-in-zen" style="margin-top:10px;">
      <div class="label">PGN Moves History</div>
    </div>
    <div id="movesList" class="hide-in-zen">No moves yet</div>
  </div>

  <div class="panel hide-in-zen" id="chatPanelContainer" style="display:none;">
    <div class="panel-header">
        <div class="label">Live Game Chat</div>
        <div id="typingIndicator" class="typing-indicator">Opponent is typing...</div>
    </div>
    <div class="chat-panel">
      <div class="chat-messages" id="chatMessages">
         <div style="text-align:center; color:#9ca3af; padding-top:20px;">No messages yet. Say Hi!</div>
      </div>
      <div style="display:flex; gap:6px; margin-top:2px;">
         <button class="small" style="flex:1; background:#334155;" onclick="sendQuickEmoji('üî•')">üî•</button>
         <button class="small" style="flex:1; background:#334155;" onclick="sendQuickEmoji('üò±')">üò±</button>
         <button class="small" style="flex:1; background:#334155;" onclick="sendQuickEmoji('üëè')">üëè</button>
         <button class="small" style="flex:1; background:#334155;" onclick="sendQuickEmoji('ü§£')">ü§£</button>
      </div>
      <div style="display:flex; gap:6px; margin-top:4px;">
        <button id="voiceChatBtn" style="background:#f59e0b; padding:0 10px;" title="Voice to Text">üé§</button>
        <input type="text" id="chatInput" placeholder="Type a message..." style="flex:1; padding:8px; border-radius:6px; border:1px solid #334155; background:#0f172a; color:#fff; font-size:12px;">
        <button id="sendChatBtn" style="background:var(--accent); color:#000;">Send</button>
      </div>
    </div>
  </div>

  <div class="panel hide-in-zen">
    <div class="label">Bot Settings (Local Play)</div>
    <div class="bot-settings">
      <div class="bot-row"><label>Difficulty</label><select id="difficultySelect"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Killer">Killer</option></select></div>
      <div class="bot-row"><label>Time Control</label><select id="timeControlSelect"><option value="none" selected>No Limit</option><option value="bullet1">Bullet 1 min</option><option value="rapid10">Rapid 10 min</option></select></div>
    </div>
  </div>

  <div class="panel hide-in-zen">
    <div class="label">Friends & Online Invite Engine</div>
    <div class="about-text">
      <div style="display:flex;gap:6px;margin-top:4px;align-items:center;">
        <input id="myId" type="text" readonly style="flex:1;padding:8px;border-radius:8px;border:1px solid #374151;background:rgba(15,23,42,0.9);color:#e5e7eb;font-size:14px;font-weight:bold;text-align:center;">
        <button id="copyIdBtn" style="background:#10b981;">üîó Copy Magic Link</button>
      </div>
      <div style="margin-top:10px;font-size:11px;color:#9ca3af;">Friend ID se Join karein:</div>
      <div style="margin-top:4px;display:flex;gap:6px;align-items:center;">
        <input id="friendIdInput" type="text" placeholder="Friend ID paste karein..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #374151;background:rgba(255,255,255,0.03);color:#e5e7eb;font-size:12px;">
        <button id="inviteFriendBtn" class="invite-btn">Send Invite</button>
      </div>
      <div id="onlineStatus" class="tagline" style="margin-top:8px;color:#38bdf8;font-weight:bold;">Connecting to Firebase‚Ä¶</div>
    </div>
  </div>

  <div id="videoCallContainer">
    <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
    <div class="local-video-box">
      <video id="localVideo" class="local-video" autoplay muted playsinline></video>
    </div>
  </div>

  <div id="inviteOverlay">
    <div id="invitePopup">
      <h2>üî• NEW CHALLENGE üî•</h2>
      <div class="invite-info">‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...</div>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button id="acceptBtn">ACCEPT & JOIN</button>
        <button id="declineBtn">DECLINE</button>
      </div>
    </div>
  </div>

  <div id="gameOverOverlay">
    <div id="gameOverPopup">
      <div style="font-size:60px; margin-bottom:10px; animation: bounce 2s infinite;">üèÜ</div>
      <h1 id="gameOverTitle">YOU WIN!</h1>
      <p id="gameOverDesc">By Checkmate</p>
      <button id="closeModalBtn" onclick="closeGameOverModal()">Close</button>
    </div>
  </div>
  <style>@keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }</style>

  <audio id="moveSound" src="move-sound.mp3" preload="auto"></audio>
  <audio id="inviteSound" src="invite-sound.mp3" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>

  <script>
    // =========================================================
    // 0. QUANTUM RIPPLE CLICKS & ZEN MODE
    // =========================================================
    document.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;
        const ripple = document.createElement('div');
        ripple.className = 'ripple-effect';
        ripple.style.left = e.clientX + 'px'; ripple.style.top = e.clientY + 'px';
        document.body.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
    });

    document.getElementById('zenBtn').onclick = () => {
        document.body.classList.toggle('zen-mode');
        const btn = document.getElementById('zenBtn');
        if(document.body.classList.contains('zen-mode')) {
            btn.innerText = "Exit Zen Mode üëÅÔ∏è"; btn.style.background = "#ef4444";
        } else {
            btn.innerText = "Zen Mode üßò"; btn.style.background = "#8b5cf6";
        }
    };

    // =========================================================
    // 0.5 AI VOICE ANNOUNCER & SYNTH AUDIO FX & HAPTICS (QUANTUM)
    // =========================================================
    function announce(text) {
        if ('speechSynthesis' in window) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = 1.1; msg.pitch = 1.2;
            window.speechSynthesis.speak(msg);
        }
    }
    
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = AudioContext ? new AudioContext() : null;
    function playProSound(type) {
        if(!audioCtx) return;
        try {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type === 'move') { 
                if(navigator.vibrate) navigator.vibrate(40); 
                osc.type = 'sine'; osc.frequency.setValueAtTime(300, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); 
                gain.gain.setValueAtTime(1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); 
                osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
            } else if(type === 'capture') { 
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]); 
                osc.type = 'square'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.15); 
                gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); 
                osc.start(); osc.stop(audioCtx.currentTime + 0.15); 
            } else if(type === 'check') { 
                if(navigator.vibrate) navigator.vibrate([200, 50, 200]); 
                osc.type = 'triangle'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
                gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); 
                osc.start(); osc.stop(audioCtx.currentTime + 0.3); 
            }
        } catch(e){}
    }

    // =========================================================
    // 1. FIREBASE CONFIGURATION
    // =========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyB33UgkoyYezqGeyYEKBE5BMUfQrxe3-PE",
      authDomain: "bosschess-c9791.firebaseapp.com",
      databaseURL: "https://bosschess-c9791-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bosschess-c9791",
      storageBucket: "bosschess-c9791.firebasestorage.app",
      messagingSenderId: "325067489020",
      appId: "1:325067489020:web:8b9321149b9aedd0286179"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // =========================================================
    // 2. CHESS & GAME VARIABLES
    // =========================================================
    const game = new Chess();
    let isMultiplayer = false;
    let multiplayerRoomId = null;
    let multiplayerColor = null; 
    let selectedSquare = null;
    let isVideoEnabled = false;
    let isMicEnabled = true;
    let isFlipped = false;
    let gameFinished = false;
    let timerInterval = null;
    let whiteTime = 600, blackTime = 600;
    let legalMoves = []; 
    let lastMove = null; 

    function generateId() {
      return Math.random().toString(36).substring(2, 6).toUpperCase() + "-" + Math.floor(1000 + Math.random() * 9000);
    }
    
    let myId = localStorage.getItem('chess_game_my_id_v1') || generateId();
    localStorage.setItem('chess_game_my_id_v1', myId);
    document.getElementById('myId').value = myId;
    
    const defaultName = localStorage.getItem('chess_name') || "Manish";
    document.getElementById('playerNameInput').value = defaultName;

    // Dynamic Lighting Tracker
    document.addEventListener('mousemove', (e) => {
        const x = (e.clientX / window.innerWidth - 0.5) * 20; 
        const y = (e.clientY / window.innerHeight - 0.5) * 20;
        document.documentElement.style.setProperty('--light-x', `${-x}px`);
        document.documentElement.style.setProperty('--light-y', `${-y}px`);
    });

    // =========================================================
    // 3. VOICE TO TEXT CHAT & PUSH-TO-TALK (THE OMNIPRESENT MIC UPDATE)
    // =========================================================
    // Voice Recognition for Chat
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        document.getElementById('voiceChatBtn').onclick = () => {
            recognition.start();
            document.getElementById('chatInput').placeholder = "Listening...";
            document.getElementById('voiceChatBtn').style.background = "#ef4444";
        };
        
        recognition.onresult = (e) => {
            const transcript = e.results[0][0].transcript;
            document.getElementById('chatInput').value = transcript;
            document.getElementById('sendChatBtn').click(); // Auto Send
            resetVoiceBtn();
        };
        recognition.onerror = resetVoiceBtn;
        recognition.onend = resetVoiceBtn;
        
        function resetVoiceBtn() {
            document.getElementById('chatInput').placeholder = "Type a message...";
            document.getElementById('voiceChatBtn').style.background = "#f59e0b";
        }
    } else {
        document.getElementById('voiceChatBtn').style.display = 'none'; // Hide if browser unsupported
    }

    // Push To Talk (Spacebar)
    let isSpacebarDown = false;
    document.addEventListener('keydown', (e) => {
        if(e.code === 'Space' && document.activeElement.tagName !== 'INPUT' && !isSpacebarDown) {
            e.preventDefault();
            isSpacebarDown = true;
            if(!isMicEnabled) document.getElementById('micTopBtn').click(); // Temporarily unmute
        }
    });
    document.addEventListener('keyup', (e) => {
        if(e.code === 'Space' && document.activeElement.tagName !== 'INPUT') {
            isSpacebarDown = false;
            if(isMicEnabled) document.getElementById('micTopBtn').click(); // Mute again
        }
    });

    // =========================================================
    // 3. MAGIC LINK URL CHECKER & AUTO-AUTH
    // =========================================================
    auth.onAuthStateChanged(user => {
      const loginContainer = document.getElementById("loginContainer");
      if (user) {
        document.getElementById('playerNameInput').value = user.displayName;
        document.getElementById('playerNameDisplay').innerHTML = `Player 1: <strong style="color:#38bdf8;">${user.displayName}</strong> (Host)`;
        document.getElementById('playerAvatarTop').src = user.photoURL;
        document.getElementById('pingTop').style.display = 'inline-block';
        
        loginContainer.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:8px;">
              <img src="${user.photoURL}" style="width:24px;height:24px;border-radius:50%;" alt="Avatar">
              <span style="font-size:13px;color:#9ca3af;">Logged in as <strong>${user.displayName}</strong></span>
            </div>
            <button onclick="firebase.auth().signOut()" class="small" style="background:#dc2626;">Logout</button>
          </div>
        `;
        db.ref('users/' + myId).set({ name: user.displayName, photoURL: user.photoURL });
      } else {
        loginContainer.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:13px;color:#9ca3af;">Login for Profile Sync</span>
            <button onclick="signInWithGoogle()" class="small">Login with Google</button>
          </div>
        `;
      }
      listenForInvites();
      
      const urlParams = new URLSearchParams(window.location.search);
      const inviteCode = urlParams.get('invite');
      if(inviteCode && inviteCode !== myId) {
          document.getElementById('friendIdInput').value = inviteCode;
          setTimeout(() => {
              document.getElementById('inviteFriendBtn').click(); 
              window.history.replaceState({}, document.title, window.location.pathname); 
          }, 1500);
      }
    });

    // Save Default Name
    document.getElementById('playerNameInput').addEventListener('input', (e) => {
        localStorage.setItem('chess_name', e.target.value);
    });

    // =========================================================
    // 4. INVITE SYSTEM & JABARDASTI FORCE ENGINE
    // =========================================================
    function listenForInvites() {
        db.ref('invites_by_gameid/' + myId).on('value', snap => {
            const data = snap.val();
            if (!data) return;
            const pendingInvites = Object.entries(data).filter(([k, v]) => v.status === 'pending');
            if (pendingInvites.length > 0) {
                const [invIdRaw, invData] = pendingInvites[0];
                window.currentPopupInvite = { inviteIdRaw: invIdRaw, inviteData: invData };
                
                const overlay = document.getElementById('inviteOverlay');
                overlay.querySelector('.invite-info').innerHTML = `<strong style="color:var(--accent); font-size:18px;">${invData.fromName || 'Opponent'}</strong> is challenging you to play & Video Call!`;
                overlay.classList.add('show');
                try{ document.getElementById('inviteSound').play(); }catch(e){}
            }
        });
    }

    document.getElementById('inviteFriendBtn').onclick = () => {
        const friendId = document.getElementById('friendIdInput').value;
        if (!friendId) return alert("Please enter Friend's Game ID");
        const invId = "INV_" + Date.now();
        const myName = document.getElementById('playerNameInput').value || defaultName;
        
        db.ref('invites_by_gameid/' + friendId + '/' + invId).set({
            fromGameId: myId, fromName: myName, status: 'pending', sentAt: Date.now()
        });

        document.getElementById('onlineStatus').innerText = "Invite Sent! Waiting for accept...";

        db.ref('invites_by_gameid/' + friendId + '/' + invId).on('value', snap => {
            if (snap.val() && snap.val().status === 'accepted') { joinGameRoom(snap.val().roomId, 'w'); }
        });
    };

    document.getElementById('acceptBtn').onclick = async function() {
        if (!window.currentPopupInvite) return;
        const { inviteIdRaw, inviteData } = window.currentPopupInvite;
        const forceRoomId = "FORCED_MATCH_" + Date.now();

        const updates = {};
        updates[`invites_by_gameid/${myId}/${inviteIdRaw}/status`] = 'accepted';
        updates[`invites_by_gameid/${myId}/${inviteIdRaw}/roomId`] = forceRoomId;
        updates[`games/${forceRoomId}`] = { pgn: "", turn: "w", updatedAt: Date.now() }; 

        await db.ref().update(updates);
        document.getElementById('inviteOverlay').classList.remove('show');
        joinGameRoom(forceRoomId, 'b');
    };

    document.getElementById('declineBtn').onclick = () => {
        document.getElementById('inviteOverlay').classList.remove('show');
        const { inviteIdRaw } = window.currentPopupInvite;
        db.ref(`invites_by_gameid/${myId}/${inviteIdRaw}`).update({status: 'declined'});
    };

    // =========================================================
    // 5. MULTIPLAYER SYNC, CHAT, TYPING & THEMES
    // =========================================================
    let typingTimer;
    
    window.joinGameRoom = function(roomId, color) {
        multiplayerRoomId = roomId;
        multiplayerColor = color;
        isMultiplayer = true;
        gameFinished = false;
        
        if(color === 'b') isFlipped = true;

        document.getElementById('onlineStatus').innerHTML = `üî• <span style="color:#4ade80;">Connected to Room: ${roomId}</span> as ${color==='w'?'White':'Black'}`;
        document.getElementById('chatPanelContainer').style.display = 'block'; 
        
        const myName = document.getElementById('playerNameInput').value || defaultName;
        db.ref(`games/${roomId}/players/${color === 'w' ? 'white' : 'black'}`).set({ name: myName, gameId: myId });

        db.ref(`games/${roomId}`).on('value', snap => {
            const data = snap.val();
            if(!data) return;

            if(data.lastMove) lastMove = data.lastMove;

            if (data.resigned) {
                if(!gameFinished) {
                    announce("Opponent Resigned");
                    showPremiumGameOver(`${data.resigned === 'w' ? 'White' : 'Black'} Resigned!`, `${data.resigned === 'w' ? 'Black' : 'White'} takes the victory.`);
                }
                gameFinished = true;
                if(timerInterval) clearInterval(timerInterval);
            }
            else if (data.pgn !== undefined && game.pgn() !== data.pgn) {
                game.load_pgn(data.pgn);
                selectedSquare = null;
                legalMoves = [];
                drawBoard();
                checkGameOver();
                if(game.in_check() && !game.in_checkmate()) { announce("Check"); playProSound('check'); }
                else if (!gameFinished) { playProSound('move'); }
            }

            if (data.players) {
                const oppKey = color === 'w' ? 'black' : 'white';
                if (data.players[oppKey] && data.players[oppKey].name) {
                    const bottomNameEl = document.getElementById('playerNameBottom');
                    bottomNameEl.innerHTML = `<span style="color:#facc15; font-size:20px;">${data.players[oppKey].name}</span>`;
                    document.getElementById('bottomNameInput').style.display = 'none';
                    document.getElementById('pingBottom').style.display = 'inline-block';
                }
            }
        });

        // Chat Sync
        db.ref(`games/${roomId}/chat`).on('child_added', snap => {
            const msgData = snap.val();
            const msgDiv = document.createElement('div');
            const isMine = msgData.senderId === myId;
            msgDiv.className = `chat-msg ${isMine ? 'mine' : 'theirs'}`;
            // Add Timestamp to Chat
            const date = new Date(msgData.timestamp);
            const timeStr = `${date.getHours()}:${date.getMinutes() < 10 ? '0':''}${date.getMinutes()}`;
            msgDiv.innerHTML = `<span>${msgData.text}</span> <span style="font-size:8px; opacity:0.6; display:block; text-align:right; margin-top:2px;">${timeStr}</span>`;
            
            const chatBox = document.getElementById('chatMessages');
            if(chatBox.innerText.includes("No messages")) chatBox.innerHTML = "";
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        // Typing Indicator Sync
        db.ref(`games/${roomId}/typing`).on('value', snap => {
            const val = snap.val();
            const indicator = document.getElementById('typingIndicator');
            if(val && val !== myId) indicator.style.display = 'block';
            else indicator.style.display = 'none';
        });

        document.getElementById('videoCallContainer').classList.add('active');
        if (color === 'b' && window.webrtcStartCallAsCaller) window.webrtcStartCallAsCaller(roomId);
        else if (color === 'w' && window.webrtcJoinCallAsAnswerer) window.webrtcJoinCallAsAnswerer(roomId);
        
        startTimers();
    };

    document.getElementById('resignBtn').onclick = () => {
        if (!isMultiplayer || gameFinished) return;
        if (confirm("Are you sure you want to resign? üè≥Ô∏è")) {
            db.ref('games/' + multiplayerRoomId).update({ resigned: multiplayerColor });
        }
    }

    window.sendQuickEmoji = function(emoji) { document.getElementById('chatInput').value += emoji; }
    
    document.getElementById('sendChatBtn').onclick = () => {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(text && isMultiplayer && multiplayerRoomId) {
            db.ref(`games/${multiplayerRoomId}/chat`).push({ text: text, senderId: myId, timestamp: Date.now() });
            db.ref(`games/${multiplayerRoomId}/typing`).set(null);
            input.value = "";
        }
    };
    
    document.getElementById('chatInput').addEventListener("input", () => {
        if(isMultiplayer && multiplayerRoomId) {
            db.ref(`games/${multiplayerRoomId}/typing`).set(myId);
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => db.ref(`games/${multiplayerRoomId}/typing`).set(null), 1500);
        }
    });

    document.getElementById('chatInput').addEventListener("keypress", function(e) { if (e.key === "Enter") document.getElementById('sendChatBtn').click(); });

    // THEME & 3D CAMERA LOGIC
    document.getElementById('themeSelect').addEventListener('change', (e) => {
        const t = e.target.value; const r = document.documentElement;
        if(t==='wood'){ r.style.setProperty('--light-square','#f0d9b5'); r.style.setProperty('--dark-square','#b58863'); }
        if(t==='glass'){ r.style.setProperty('--light-square','#cbd5e1'); r.style.setProperty('--dark-square','#334155'); }
        if(t==='emerald'){ r.style.setProperty('--light-square','#a7f3d0'); r.style.setProperty('--dark-square','#065f46'); }
        if(t==='neon'){ r.style.setProperty('--light-square','#fbcfe8'); r.style.setProperty('--dark-square','#701a75'); }
    });
    
    document.getElementById('skinSelect').addEventListener('change', (e) => {
        document.getElementById('board').className = 'board ' + e.target.value;
    });

    document.getElementById('cameraAngle').addEventListener('input', (e) => {
        document.getElementById('boardFrame').style.transform = `rotateX(${e.target.value}deg)`;
    });

    document.getElementById('cinematicBtn').onclick = () => {
        document.getElementById('boardFrame').classList.toggle('cinematic-mode');
    };

    // =========================================================
    // 6. 3D BOARD RENDERER, EVAL BAR, IMPACT SHAKE
    // =========================================================
    const pieceImages3D = {
        "P":"PAWNS-IMAGEPRO.JPG", "N":"KNIGHTS-IMAGEPRO.JPG", "B":"BISHOPS-IMAGEPRO.JPG",
        "R":"ROOKS-IMAGEPRO.JPG", "Q":"QUEEN-IMAGEPRO.JPG", "K":"KING-IMAGEPRO.JPG",
        "p":"pawns-image.jpg", "n":"knights-image.jpg", "b":"bishops-image.jpg",
        "r":"rooks-image.jpg", "q":"Queen-image.jpg", "k":"king-image.jpg"
    };

    const boardEl = document.getElementById("board");
    const boardFrame = document.getElementById("boardFrame");
    const statusEl = document.getElementById("status");
    
    function updateEvalBar() {
        const boardState = game.board();
        let whiteMaterial = 0; let blackMaterial = 0;
        const values = { 'p': 1, 'n': 3, 'b': 3, 'r': 5, 'q': 9, 'k': 0 };
        
        for(let r=0; r<8; r++) {
            for(let c=0; c<8; c++) {
                let piece = boardState[r][c];
                if(piece) {
                    if(piece.color === 'w') whiteMaterial += values[piece.type];
                    else blackMaterial += values[piece.type];
                }
            }
        }
        
        let score = whiteMaterial - blackMaterial;
        let percentage = 50 + (score * 2); 
        if(percentage < 5) percentage = 5;
        if(percentage > 95) percentage = 95;
        
        if(isFlipped) {
             document.getElementById('evalWhite').style.height = (100 - percentage) + "%";
             document.getElementById('evalBlack').style.height = percentage + "%";
        } else {
             document.getElementById('evalWhite').style.height = percentage + "%";
             document.getElementById('evalBlack').style.height = (100 - percentage) + "%";
        }
    }

    function drawBoard() {
        boardEl.innerHTML = "";
        const fenArr = game.fen().split(" ")[0].split("/");
        
        for (let row = 0; row < 8; row++) {
            let cIdx = 0;
            for (let char of fenArr[row]) {
                if (isNaN(char)) { createSquare(row, cIdx, char); cIdx++; } 
                else { for (let i = 0; i < parseInt(char); i++) { createSquare(row, cIdx, null); cIdx++; } }
            }
        }
        
        updateMovesList();
        updateCapturedPieces();
        updateEvalBar();
        
        if(!gameFinished) {
            const isWhiteTurn = game.turn() === 'w';
            statusEl.innerText = isWhiteTurn ? "White to move" : "Black to move";
            if (game.in_check()) statusEl.innerText += " (CHECK! üö®)";
            boardFrame.className = "board-frame " + (isWhiteTurn ? "turn-glow-white" : "turn-glow-black");
            
            document.getElementById("whiteTimerBox").className = "timer-box " + (isWhiteTurn ? "timer-active" : "");
            document.getElementById("blackTimerBox").className = "timer-box " + (!isWhiteTurn ? "timer-active" : "");
        }
    }

    function createSquare(r, c, p) {
        const sq = document.createElement('div');
        sq.className = `square ${(r + c) % 2 === 0 ? 'light' : 'dark'}`;
        
        const displayRow = isFlipped ? 7 - r : r;
        const displayCol = isFlipped ? 7 - c : c;
        
        sq.style.top = (displayRow * 12.5) + "%"; 
        sq.style.left = (displayCol * 12.5) + "%";
        const pos = String.fromCharCode(97 + c) + (8 - r);
        sq.dataset.square = pos;
        
        if (p) {
            const img = document.createElement('img');
            img.src = pieceImages3D[p];
            img.className = "piece-img";
            sq.appendChild(img);
        }

        if ((!isFlipped && r === 7) || (isFlipped && r === 0)) {
            const letter = document.createElement('div'); letter.className = 'coord-letter'; letter.innerText = pos[0]; sq.appendChild(letter);
        }
        if ((!isFlipped && c === 0) || (isFlipped && c === 7)) {
            const num = document.createElement('div'); num.className = 'coord-number'; num.innerText = pos[1]; sq.appendChild(num);
        }
        
        if (selectedSquare === pos) sq.classList.add('selected');
        if (lastMove && (pos === lastMove.from || pos === lastMove.to)) sq.classList.add('last-move');
        if (game.in_check() && ((game.turn() === 'w' && p === 'K') || (game.turn() === 'b' && p === 'k'))) sq.classList.add('in-check');

        const moveData = legalMoves.find(m => m.to === pos);
        if(moveData) {
            const dot = document.createElement('div');
            dot.className = moveData.captured ? "hint-capture" : "hint-dot";
            sq.appendChild(dot);
        }

        sq.onclick = () => {
            if (gameFinished) return;
            if (isMultiplayer && game.turn() !== multiplayerColor) return;
            
            if (selectedSquare) {
                const move = game.move({ from: selectedSquare, to: pos, promotion: 'q' });
                if (move) {
                    lastMove = { from: move.from, to: move.to };
                    if (isMultiplayer) db.ref('games/' + multiplayerRoomId).update({ pgn: game.pgn(), lastMove: lastMove });
                    
                    // Shake & Synth Sound
                    if(move.captured) {
                        boardFrame.classList.add('shake-impact');
                        setTimeout(()=>boardFrame.classList.remove('shake-impact'), 300);
                        announce("Capture");
                        playProSound('capture');
                    } else {
                        playProSound('move');
                    }
                    
                    if(game.in_check() && !game.in_checkmate()) { announce("Check!"); playProSound('check'); }
                    checkGameOver();
                }
                selectedSquare = null;
                legalMoves = [];
                drawBoard();
            } else if (p && ((game.turn() === 'w' && p === p.toUpperCase()) || (game.turn() === 'b' && p === p.toLowerCase()))) {
                selectedSquare = pos;
                legalMoves = game.moves({ square: pos, verbose: true }); 
                drawBoard();
            }
        };
        boardEl.appendChild(sq);
    }

    function updateCapturedPieces() {
        const history = game.history({ verbose: true });
        let wCap = "", bCap = "";
        const symbols = { 'p': '‚ôü', 'n': '‚ôû', 'b': '‚ôù', 'r': '‚ôú', 'q': '‚ôõ' };
        
        history.forEach(move => {
            if(move.captured) {
                if(move.color === 'w') wCap += symbols[move.captured]; 
                else bCap += symbols[move.captured]; 
            }
        });

        if(isFlipped) {
            document.getElementById('capturedTop').innerText = wCap ? "üíÄ " + wCap : "";
            document.getElementById('capturedBottom').innerText = bCap ? "üíÄ " + bCap : "";
        } else {
            document.getElementById('capturedTop').innerText = bCap ? "üíÄ " + bCap : "";
            document.getElementById('capturedBottom').innerText = wCap ? "üíÄ " + wCap : "";
        }
    }

    function updateMovesList(){
        const movesListEl = document.getElementById("movesList");
        const hist = game.history();
        if(!hist.length){ movesListEl.textContent = "No moves yet"; return; }
        movesListEl.innerHTML = "";
        for(let i=0; i<hist.length; i+=2){
            const row = document.createElement("div"); row.className = "move-row";
            row.innerHTML = `<div class="move-index">${(i/2+1)}.</div><div style="flex:1; font-weight:bold; color:var(--accent);">${hist[i]}</div><div style="flex:1; font-weight:bold; color:var(--gold);">${hist[i+1] || ""}</div>`;
            movesListEl.appendChild(row);
        }
        movesListEl.scrollTop = movesListEl.scrollHeight;
    }

    // CONFETTI LOGIC
    function startConfetti() {
        const canvas = document.getElementById('confettiCanvas');
        const ctx = canvas.getContext('2d');
        canvas.style.display = 'block';
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        for(let i=0; i<150; i++) {
            particles.push({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                w: Math.random() * 10 + 5, h: Math.random() * 10 + 5,
                c: ['#facc15', '#38bdf8', '#10b981', '#ef4444', '#a855f7'][Math.floor(Math.random() * 5)],
                s: Math.random() * 3 + 2, r: Math.random() * 360
            });
        }
        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach(p => {
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r * Math.PI / 180);
                ctx.fillStyle = p.c; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                p.y += p.s; p.r += p.s; if(p.y > canvas.height) p.y = -10;
            });
            window.confettiId = requestAnimationFrame(draw);
        }
        draw();
    }

    function stopConfetti() {
        document.getElementById('confettiCanvas').style.display = 'none';
        cancelAnimationFrame(window.confettiId);
    }

    function showPremiumGameOver(title, desc) {
        document.getElementById('gameOverTitle').innerText = title;
        document.getElementById('gameOverDesc').innerText = desc;
        document.getElementById('gameOverOverlay').classList.add('show');
        startConfetti();
        if(navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 300]); // Haptic win
    }
    
    window.closeGameOverModal = function() {
        document.getElementById('gameOverOverlay').classList.remove('show');
        stopConfetti();
    }

    function checkGameOver() {
        if (game.in_checkmate()) {
            gameFinished = true;
            statusEl.innerText = `Checkmate! ${game.turn() === 'w' ? 'Black' : 'White'} Wins! üèÜ`;
            statusEl.style.color = "#4ade80";
            if(timerInterval) clearInterval(timerInterval);
            
            announce("Checkmate!");
            showPremiumGameOver("CHECKMATE! üèÜ", `${game.turn() === 'w' ? 'Black' : 'White'} takes the Crown.`);
        } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
            gameFinished = true;
            statusEl.innerText = "Match Drawn ü§ù";
            statusEl.style.color = "#facc15";
            if(timerInterval) clearInterval(timerInterval);
            
            announce("Draw!");
            showPremiumGameOver("MATCH DRAWN ü§ù", "It's a tie between Legends.");
        }
    }

    function startTimers() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(gameFinished) return;
            if (game.turn() === 'w') whiteTime--; else blackTime--;
            
            if (whiteTime <= 0 || blackTime <= 0) {
                gameFinished = true;
                clearInterval(timerInterval);
                statusEl.innerText = `Time Out! ${whiteTime <= 0 ? 'Black' : 'White'} Wins!`;
                announce("Time out!");
                showPremiumGameOver("TIME OUT! ‚è≥", `${whiteTime <= 0 ? 'Black' : 'White'} Wins on time.`);
            }
            
            document.getElementById('whiteTimer').innerText = formatTime(Math.max(0, whiteTime));
            document.getElementById('blackTimer').innerText = formatTime(Math.max(0, blackTime));
        }, 1000);
    }
    
    function formatTime(sec) {
        const m = Math.floor(sec / 60); const s = sec % 60;
        return (m < 10 ? "0"+m : m) + ":" + (s < 10 ? "0"+s : s);
    }

    document.getElementById('flipBtn').onclick = () => { isFlipped = !isFlipped; drawBoard(); };
    document.getElementById('resetBtn').onclick = () => { 
        game.reset(); gameFinished = false; whiteTime = 600; blackTime = 600; 
        selectedSquare = null; legalMoves = []; lastMove = null; drawBoard(); 
        if (isMultiplayer) db.ref('games/' + multiplayerRoomId).update({ pgn: game.pgn(), lastMove: null, resigned: null });
        stopConfetti();
    };
    
    // MAGIC LINK COPIER
    document.getElementById('copyIdBtn').onclick = () => { 
        const link = window.location.origin + window.location.pathname + "?invite=" + myId;
        navigator.clipboard.writeText(link); 
        alert("Magic Invite Link Copied! Send it to your friend."); 
    };

    // =========================================================
    // 7. WHATSAPP DRAGGABLE VIDEO LOGIC (TOUCH + MOUSE)
    // =========================================================
    (function() {
        const dragElement = document.getElementById("videoCallContainer");
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        dragElement.onmousedown = dragMouseDown;
        dragElement.ontouchstart = dragTouchStart;

        function dragMouseDown(e) {
            e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY;
            document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
        }
        function elementDrag(e) {
            e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
            pos3 = e.clientX; pos4 = e.clientY;
            dragElement.style.top = (dragElement.offsetTop - pos2) + "px";
            dragElement.style.left = (dragElement.offsetLeft - pos1) + "px";
        }
        function dragTouchStart(e) {
            pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY;
            document.ontouchend = closeDragElement; document.ontouchmove = elementTouchDrag;
        }
        function elementTouchDrag(e) {
            pos1 = pos3 - e.touches[0].clientX; pos2 = pos4 - e.touches[0].clientY;
            pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY;
            dragElement.style.top = (dragElement.offsetTop - pos2) + "px";
            dragElement.style.left = (dragElement.offsetLeft - pos1) + "px";
        }
        function closeDragElement() {
            document.onmouseup = null; document.onmousemove = null;
            document.ontouchend = null; document.ontouchmove = null;
        }
    })();

    window.onload = drawBoard;
  </script>

  <script>
    (async function(){
        const rtcDb = firebase.database();
        const rtcState = {}; 
        
        let visualizerCtx, analyser, dataArray;

        function createPeerConnection(roomId){
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            pc.onicecandidate = e => {
                if(e.candidate) rtcDb.ref('webrtc/' + roomId).push({ type:'candidate', candidate: JSON.stringify(e.candidate) });
            };
            pc.ontrack = e => {
                const remoteVid = document.getElementById('remoteVideo');
                remoteVid.srcObject = e.streams[0];
            };
            return pc;
        }

        function setupVisualizer(stream) {
            if(!visualizerCtx) visualizerCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(visualizerCtx.state === 'suspended') visualizerCtx.resume();
            analyser = visualizerCtx.createAnalyser();
            const source = visualizerCtx.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVisualizer();
        }

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            if(!isMicEnabled) {
                document.getElementById('playerAvatarTop').style.boxShadow = `0 4px 10px rgba(0,0,0,0.6)`;
                return;
            }
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let avg = sum / dataArray.length;
            let glow = avg * 1.5; 
            document.getElementById('playerAvatarTop').style.boxShadow = `0 0 ${glow}px var(--accent), 0 0 ${glow/2}px var(--accent)`;
        }

        async function getStream(){
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = stream;
                stream.getVideoTracks().forEach(t => t.enabled = isVideoEnabled);
                stream.getAudioTracks().forEach(t => t.enabled = isMicEnabled);
                
                setupVisualizer(stream); // Attach visualizer to mic
                return stream;
            } catch(err) {
                console.warn("Camera/Mic Permission denied", err);
                return new MediaStream(); 
            }
        }

        function listenSignaling(roomId){
            rtcDb.ref('webrtc/' + roomId).on('child_added', async snap => {
                const msg = snap.val();
                const st = rtcState[roomId];
                if(!st) return;
                
                if (msg.type === 'offer') {
                    await st.pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.sdp)));
                    const answer = await st.pc.createAnswer();
                    await st.pc.setLocalDescription(answer);
                    rtcDb.ref('webrtc/' + roomId).push({ type:'answer', sdp: JSON.stringify(st.pc.localDescription) });
                } else if (msg.type === 'answer') {
                    await st.pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.sdp)));
                } else if (msg.type === 'candidate') {
                    st.pc.addIceCandidate(JSON.parse(msg.candidate));
                }
            });
        }

        window.webrtcStartCallAsCaller = async function(roomId){
            const stream = await getStream();
            const pc = createPeerConnection(roomId);
            stream.getTracks().forEach(t => pc.addTrack(t, stream));
            rtcState[roomId] = { pc, stream };
            listenSignaling(roomId);

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            rtcDb.ref('webrtc/' + roomId).push({ type:'offer', sdp: JSON.stringify(pc.localDescription) });
        };

        window.webrtcJoinCallAsAnswerer = async function(roomId){
            const stream = await getStream();
            const pc = createPeerConnection(roomId);
            stream.getTracks().forEach(t => pc.addTrack(t, stream));
            rtcState[roomId] = { pc, stream };
            listenSignaling(roomId);
        };

        document.getElementById('videoToggleBtn').onclick = () => {
            isVideoEnabled = !isVideoEnabled;
            document.getElementById('videoToggleBtn').innerText = isVideoEnabled ? "Video: ON" : "Video: OFF";
            document.getElementById('videoCallContainer').classList.toggle('active', isVideoEnabled);
            
            if (multiplayerRoomId && rtcState[multiplayerRoomId]) {
                const stream = rtcState[multiplayerRoomId].stream;
                stream.getVideoTracks().forEach(t => t.enabled = isVideoEnabled);
            } else if (!isMultiplayer && isVideoEnabled) {
                navigator.mediaDevices.getUserMedia({video: true}).then(s => {
                    document.getElementById('localVideo').srcObject = s;
                });
            }
        };

        document.getElementById('micTopBtn').onclick = function() {
            isMicEnabled = !isMicEnabled;
            const btn = this;
            const label = btn.querySelector('.mic-label');
            if (isMicEnabled) {
                btn.className = "small mic-btn mic-on";
                label.innerText = "Mic On";
                if(visualizerCtx && visualizerCtx.state === 'suspended') visualizerCtx.resume();
            } else {
                btn.className = "small mic-btn mic-off";
                label.innerText = "Mic Off";
            }

            if (multiplayerRoomId && rtcState[multiplayerRoomId]) {
                const stream = rtcState[multiplayerRoomId].stream;
                stream.getAudioTracks().forEach(t => t.enabled = isMicEnabled);
            }
        };
    })();
  </script>
</body>
</html>
